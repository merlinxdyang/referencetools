<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚è€ƒæ–‡çŒ®æ ¼å¼è½¬æ¢å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .api-section {
            transition: all 0.3s ease;
        }

        .hidden {
            display: none;
        }

        select, input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .model-select-container {
            margin-top: 10px;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.reset {
            background-color: #f44336;
        }

        button.reset:hover {
            background-color: #da190b;
        }

        .result {
            margin-top: 20px;
            white-space: pre-wrap;
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .loading {
            display: none;
            margin: 20px 0;
            padding: 10px;
            background-color: #e8f0fe;
            border-radius: 4px;
            text-align: center;
        }

        .loading.show {
            display: block;
        }

        #errorMessage {
            color: red;
            margin: 10px 0;
            padding: 10px;
            background-color: #fff3f3;
            border-radius: 4px;
            display: none;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .settings-saved {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‚è€ƒæ–‡çŒ®æ ¼å¼è½¬æ¢å·¥å…· ğŸ˜ºv1.0</h1>
        <div class="container">
    
            
            <div class="description-section">
                <p class="tool-description">
                    è¿™æ˜¯ä¸€ä¸ªå¸®åŠ©ä½ å¿«é€Ÿè½¬æ¢å‚è€ƒæ–‡çŒ®æ ¼å¼çš„å·¥å…·ã€‚ä½¿ç”¨è¯´æ˜ï¼š
                </p>
                <ol class="instruction-list">
                    <li>é¦–å…ˆé…ç½® APIï¼Œé€‰æ‹©æä¾›å•†å¹¶è¾“å…¥ API Key</li>
                    <li>å»ºè®®ä½¿ç”¨OpenRouterçš„gpt-4o-miniæ¨¡å‹ï¼Œæ¯”è¾ƒä¾¿å®œ</li>
                    <li>åœ¨"ç›®æ ‡å‚è€ƒæ–‡çŒ®æ ¼å¼"ä¸­ç²˜è´´ä½ æƒ³è¦è½¬æ¢æˆçš„ç›®æ ‡æ ¼å¼æ ·ä¾‹</li>
                    <li>åœ¨"è¾“å…¥éœ€è¦è½¬æ¢çš„å‚è€ƒæ–‡çŒ®"ä¸­ç²˜è´´éœ€è¦è½¬æ¢çš„å‚è€ƒæ–‡çŒ®</li>
                    <li>ç‚¹å‡»"è½¬æ¢å‚è€ƒæ–‡çŒ®"æŒ‰é’®å³å¯è·å¾—è½¬æ¢ç»“æœ</li>
                    <li>å¦‚æœéœ€è¦æ›´æ¢apiï¼Œé‡æ–°åŠ è½½é¡µé¢å³å¯</li>
                </ol>
                <p class="note">
                    æ³¨æ„ï¼šè½¬æ¢ç»“æœå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Œä¹Ÿå¯ä»¥ä¸‹è½½ä¸º TXT æˆ– RTF æ ¼å¼
                </p>
            </div>
        <div class="section api-section" id="apiSection">
            <h2>API è®¾ç½®</h2>
            <div id="settingsSaved" class="settings-saved">è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼</div>
            <select id="apiProvider" onchange="handleApiProviderChange()">
                <option value="">è¯·é€‰æ‹© API æä¾›å•†</option>
                <option value="openai">OpenAI</option>
                <option value="claude">Claude</option>
                <option value="openrouter">OpenRouter</option>
                <option value="deepseek">DeepSeek</option>
            </select>

            <div id="modelSelectContainer" class="model-select-container hidden">
                <select id="modelSelect">
                    <option value="">è¯·é€‰æ‹©æ¨¡å‹</option>
                    <option value="openai/gpt-4o-mini-2024-07-18">GPT-4o-mini</option>
                    <option value="openai/gpt-4-0125-preview">GPT-4o</option>
                    <option value="anthropic/claude-3-sonnet-20240229">Claude-3 Sonnet</option>
                    <option value="google/gemini-pro">Gemini Pro</option>
                </select>
            </div>

            <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥ API Key">
            <button onclick="saveApiSettings()">ä¿å­˜ API è®¾ç½®</button>
        </div>

        <div class="section">
            <h2>ç›®æ ‡å‚è€ƒæ–‡çŒ®æ ¼å¼</h2>
            <textarea id="referenceStyle" placeholder="è¯·ç²˜è´´ç›®æ ‡å‚è€ƒæ–‡çŒ®æ ¼å¼æ ·ä¾‹"></textarea>
        </div>

        <div class="section">
            <h2>è¾“å…¥éœ€è¦è½¬æ¢çš„å‚è€ƒæ–‡çŒ®</h2>
            <textarea id="inputReferences" placeholder="è¯·è¾“å…¥éœ€è¦è½¬æ¢çš„å‚è€ƒæ–‡çŒ®"></textarea>
        </div>

        <div class="section">
            <div id="loadingMessage" class="loading">æ­£åœ¨è½¬æ¢ä¸­ï¼Œè¯·ç¨å€™...</div>
            <div id="errorMessage"></div>
            <button onclick="convertReferences()">è½¬æ¢å‚è€ƒæ–‡çŒ®</button>
            <button class="reset" onclick="resetContent()">é‡ç½®å†…å®¹</button>
        </div>

        <div class="section result hidden" id="resultSection">
            <h2>è½¬æ¢ç»“æœ</h2>
            <div id="resultContent"></div>
            <button onclick="downloadTxt()">ä¸‹è½½ TXT</button>
            <button onclick="downloadRtf()">ä¸‹è½½ RTF</button>
        </div>
    </div>

    <script>
        let apiSettings = {
            provider: '',
            key: '',
            model: ''
        };

        function handleApiProviderChange() {
            const provider = document.getElementById('apiProvider').value;
            const modelSelectContainer = document.getElementById('modelSelectContainer');
            
            if (provider === 'openrouter') {
                modelSelectContainer.classList.remove('hidden');
            } else {
                modelSelectContainer.classList.add('hidden');
            }
        }

        function saveApiSettings() {
            const provider = document.getElementById('apiProvider').value;
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            if (!provider || !key) {
                showError('è¯·é€‰æ‹©APIæä¾›å•†å¹¶è¾“å…¥API Key');
                return;
            }

            if (provider === 'openrouter' && !model) {
                showError('ä½¿ç”¨OpenRouteræ—¶è¯·é€‰æ‹©æ¨¡å‹');
                return;
            }

            apiSettings.provider = provider;
            apiSettings.key = key;
            apiSettings.model = model;

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæ¶ˆæ¯
            const settingsSaved = document.getElementById('settingsSaved');
            settingsSaved.style.display = 'block';
            setTimeout(() => {
                settingsSaved.style.display = 'none';
                document.getElementById('apiSection').classList.add('hidden');
            }, 2000);

            hideError();
        }

        function resetContent() {
            document.getElementById('inputReferences').value = '';
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('resultContent').textContent = '';
            hideError();
        }

        async function convertReferences() {
            if (!apiSettings.provider || !apiSettings.key) {
                showError('è¯·å…ˆå®ŒæˆAPIè®¾ç½®');
                return;
            }

            const referenceStyle = document.getElementById('referenceStyle').value;
            const inputReferences = document.getElementById('inputReferences').value;

            if (!referenceStyle || !inputReferences) {
                showError('è¯·è¾“å…¥ç›®æ ‡æ ¼å¼å’Œéœ€è¦è½¬æ¢çš„å‚è€ƒæ–‡çŒ®');
                return;
            }

            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.classList.add('show');
            hideError();

            const prompt = `You are a professional expert in formatting journal paper references. Your task is to convert references from one style to another with precision and attention to detail.
Here is the target reference style that you need to follow:
${referenceStyle}
(1) Carefully examine the input references and identify their current format.
(2) Convert each reference into the target style exactly as specified, ensuring all details (e.g., punctuation, capitalization, order, abbreviations, etc.) match the target format.
(3) Double-check your output for consistency and accuracy to ensure it complies with the target style.
Your goal is to produce perfectly formatted references in the target style, regardless of the original style or structure of the input.

Input references:
${inputReferences}`;

            try {
                const result = await callApi(prompt);
                displayResult(result);
            } catch (error) {
                showError('è½¬æ¢è¿‡ç¨‹ä¸­å‡ºé”™ï¼š' + error.message);
                console.error('API Error:', error);
            } finally {
                loadingMessage.classList.remove('show');
            }
        }

        async function callApi(prompt) {
            let apiUrl, headers, body;

            switch(apiSettings.provider) {
                case 'openai':
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    };
                    body = JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{
                            role: "user",
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    });
                    break;
                case 'openrouter':
                    apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Reference Format Converter'
                    };
                    body = JSON.stringify({
                        model: apiSettings.model,
                        messages: [{
                            role: "user",
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    });
                    break;
                default:
                    throw new Error('ä¸æ”¯æŒçš„APIæä¾›å•†');
            }

            console.log('Sending request to:', apiUrl);
            console.log('Request headers:', headers);
            console.log('Request body:', body);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                const responseData = await response.json();
                console.log('API Response:', responseData);

                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(responseData)}`);
                }

                if (!responseData.choices || !responseData.choices[0] || !responseData.choices[0].message) {
                    throw new Error('API è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                return responseData.choices[0].message.content;
            } catch (error) {
                console.error('API call failed:', error);
                throw new Error(`API è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        function displayResult(result) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            resultSection.classList.remove('hidden');
            resultContent.textContent = result;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
        }

        function downloadTxt() {
            const content = document.getElementById('resultContent').textContent;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'references.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadRtf() {
            const content = document.getElementById('resultContent').textContent;
            const rtfContent = `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0\\froman Times New Roman;}}
\\viewkind4\\uc1\\pard\\f0\\fs24 ${content.replace(/\n/g, '\\par\n')}
}`;
            
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'references.rtf';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>